<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatBot Sheets</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:transparent;font-size:11px}

    .chat-container{
      position:fixed;
      top:0.1cm;
      left:0.1cm;
      right:0.1cm;
      max-width:400px;
      margin:0 auto;
      height:calc(100vh - .5cm);
      border:1px solid #ccc;
      border-radius:10px;
      background:#fff;
      box-shadow:0 2px 2px rgba(0,0,0,.2);
      display:flex;
      flex-direction:column;
    }

    .chat-header{
      background:#007bff;
      color:#fff;
      padding:15px;
      border-radius:10px 10px 0 0;
      font-weight:bold
    }
    .chat-messages{
      flex:1;
      padding:10px;
      overflow-y:auto
    }
    .message{
      margin:8px 0;
      padding:10px;
      border-radius:8px;
      max-width:100%;
      white-space:pre-line;
      word-break:break-word;
    }
    .user-message{
      background:#d1e7ff;
      align-self:flex-end;
      text-align:right
    }
    .bot-message{
      background:#f1f1f1;
      align-self:flex-start
    }
    .message a{
      color:#007bff;
      text-decoration:underline
    }

    .chat-input{
      display:flex;
      border-top:1px solid #ccc
    }
    .chat-input input{
      flex:1;
      padding:12px;
      border:none;
      outline:none;
      font-size:11px
    }
    .chat-input button{
      font-size:11px;
      padding:12px;
      background:#007bff;
      color:#fff;
      border:none;
      cursor:pointer
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">ðŸ¤– Bot Assistant [ Klimis Menjawab ]</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="userInput" type="text" placeholder="Tulis pesan..." />
      <button onclick="sendMessage()">Kirim</button>
    </div>
  </div>

  <script>
    /* ---------- konfigurasi ---------- */
    const SHEET_ID = '1REf1Z_Bxp91X_FMcgiEHOwAHl-hwAm44YXHGIvw3aXY';
    const SHEET_NM = 'Sheet1';

    /* ---------- cache di RAM ---------- */
    let sheetCache = null;
    let cacheValid = false;

    /* ---------- fetch + parse (hanya 1Ã—) ---------- */
    async function getSheetData() {
      if (cacheValid) return sheetCache;
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NM}`;
      try {
        const r   = await fetch(url);
        if (!r.ok) throw new Error(r.status);
        const txt = await r.text();
        const raw = JSON.parse(txt.slice(47, -2));
        sheetCache = raw.table.rows.map(row => ({
          question: row.c[0]?.v || '',
          keywords: row.c[1]?.v || '',
          answer:   row.c[2]?.v || ''
        }));
        cacheValid = true;
      } catch (e) {
        console.error('[Sheet] gagal', e);
        sheetCache = [];
      }
      return sheetCache;
    }

    /* ---------- pencocokan kata kunci ---------- */
    function findAnswer(data, input) {
      const q = input.toLowerCase().trim();
      for (const it of data) {
        for (const k of it.keywords.toLowerCase().split(',')) {
          if (q.includes(k.trim())) return it.answer;
        }
        if (it.question.toLowerCase().includes(q)) return it.answer;
      }
      return "Maaf, saya tidak mengerti. Silakan coba pertanyaan lain.";
    }

    /* ---------- UI ---------- */
    function addMessage(text, sender) {
      const box = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = `message ${sender === 'user' ? 'user-message' : 'bot-message'}`;
      div.innerHTML = text.replace(
        /(https?:\/\/[^\s/$.?#].[^\s"]*)/gi,
        '<a href="$1" target="_blank" rel="noopener">$1</a>'
      );
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
      const inp = document.getElementById('userInput');
      const txt = inp.value.trim();
      if (!txt) return;
      addMessage(txt, 'user');
      inp.value = '';
      const data = await getSheetData();
      const rep  = findAnswer(data, txt);
      setTimeout(() => addMessage(rep, 'bot'), 400);
    }

    document.getElementById('userInput').addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    /* ---------- pesan pembuka + prefetch di belakang ---------- */
    window.addEventListener('DOMContentLoaded', () => {
      addMessage(
        'Semangat Pagi, dengan Klimis dapat kami bantu, ketik Menu Pilihan (1P/2P/3P/4P), sesuai yang dikehendaki :\n' +
        'â€¢ 1P Biaya\n' +
        'â€¢ 2P Tahap Pemeliharaan Sertifikat\n' +
        'â€¢ 3P Syarat Sertifikat Dipelihara\n' +
        'â€¢ 4P Panduan Input Daftar',
        'bot'
      );
      getSheetData(); // mulai fetch sheet di belakang
    });
  </script>
</body>
</html>
